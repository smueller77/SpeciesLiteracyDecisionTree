import pandas as pd
from sklearn.tree import DecisionTreeClassifier, plot_tree
from sklearn.preprocessing import OrdinalEncoder
import matplotlib.pyplot as plt

# 1. Daten laden
df = pd.read_csv('data/DatenDecisionTree.csv', sep=';')

# Vereinfache PG02: Fasse alle "nein (grund)" Antworten zu "nein" zusammen
df['PG02'] = df['PG02'].str.lower().apply(
    lambda x: 'ja' if 'ja' in str(x) else ('nein' if 'nein' in str(x) else x)
)

# Erstelle Mapping für kategorische Variablen mit expliziter Ordnung
category_mappings = {
    'PG02': ['nein', 'ja'],  # 0 = nein, 1 = ja
}

# Ordinal-Encoding für kategorische Variablen
ordinal_encoders = {}
for col, categories in category_mappings.items():
    if col in df.columns:
        encoder = OrdinalEncoder(categories=[categories], dtype=float)
        df[col] = encoder.fit_transform(df[[col]])
        ordinal_encoders[col] = (encoder, categories)

# 2. Definition der korrekten Bestimmungen laut Confusion Matrix [3]
toxic_species = ['PA03', 'PA05', 'PA07', 'PA09', 'PA17', 'PA19']
edible_species = ['PA11', 'PA13', 'PA15', 'PA21', 'PA23', 'PA25']

def check_determination_success(row):
    correct_count = 0
    # Korrekte Bestimmung von Giftpilzen
    for s in toxic_species:
        if 'giftig' in str(row[s]).lower(): correct_count += 1
    # Korrekte Bestimmung von Speisepilzen
    for s in edible_species:
        if 'essbar' in str(row[s]).lower(): correct_count += 1
    
    # Zielvariable: 1 wenn über dem Durchschnitt von 3.0 korrekt bestimmt wurde [1]
    return 1 if correct_count > 3 else 0

# 3. Zielvariable (y) und Merkmale (X) definieren
y = df.apply(check_determination_success, axis=1)

# Auswahl der Prädiktoren basierend auf der Regressionsanalyse der Studie [4]
feature_cols = ['SD05', 'SD01', 'SD02_01', 'NB01', 'NB02_01', 'PG02']

# Mapping von Codes zu vollständigen Namen
feature_names_mapping = {
    'SD05': 'Place of residence',
    'SD01': 'Gender',
    'SD02_01': 'Age',
    'NB01': 'Nature connectedness',
    'NB02_01': 'Time spent in nature',
    'PG02': 'Collecting behavior'
}

X = pd.get_dummies(df[feature_cols], drop_first=False)

# Create mapping for categorical value display
categorical_feature_mapping = {
    'PG02': {0.0: 'No', 1.0: 'Yes'}
}

# Erstelle aussagekräftige Feature-Namen mit vollständigen Bezeichnungen
feature_display_names = []
for col in X.columns:
    # Versuche zuerst exakte Übereinstimmung
    if col in feature_names_mapping:
        feature_display_names.append(feature_names_mapping[col])
    else:
        # Extrahiere den ursprünglichen Feature-Namen (vor One-Hot-Encoding)
        base_feature = col.split('_')[0] if '_' in col else col
        if base_feature in feature_names_mapping:
            display_name = feature_names_mapping[base_feature]
            # Wenn es unterschiedliche Spalten gibt, füge die Kategorie hinzu
            if col != base_feature:
                category = col[len(base_feature)+1:]
                # Check if this is a categorical feature with a mapping
                if base_feature in categorical_feature_mapping:
                    try:
                        category_numeric = float(category)
                        category_display = categorical_feature_mapping[base_feature].get(category_numeric, category)
                    except (ValueError, TypeError):
                        category_display = category
                else:
                    category_display = category
                feature_display_names.append(f"{display_name} = {category_display}")
            else:
                feature_display_names.append(display_name)
        else:
            feature_display_names.append(col)

# 4. Decision Tree Modell trainieren
clf = DecisionTreeClassifier(max_depth=3, criterion='entropy', random_state=42)
clf.fit(X, y)

# 5. Visualisierung
plt.figure(figsize=(20,10))
plot_tree(clf, 
          feature_names=feature_display_names, 
          class_names=['false/unknown (<=3)', 'true (>3)'], 
          filled=True, rounded=True, fontsize=10)
plt.title("Factor Analysis for Species Identification Competence (Edibility of all 12 Mushroom Species)")
plt.show()
print("")